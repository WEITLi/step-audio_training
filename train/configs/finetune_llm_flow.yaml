# 基础配置
basic:
  seed: 42
  device: "cpu"  # 改为 CPU 以兼容 GTX 1080 Ti
  max_epoch: 50
  log_interval: 50
  val_interval: 1
  train_mode: "both"  # "llm" | "flow" | "both"

# 模型配置
model:
  llm:
    model_path: "./pretrained_models/stepaudio_editx/Step-Audio-EditX"
    lora: True
    lora_r: 8
    lora_alpha: 32
    lora_dropout: 0.05
    lora_target_modules: ["q_proj", "v_proj", "k_proj"]
    freeze_backbone: True
  
  tokenizer:
    model_path: "./pretrained_models/stepaudio_editx/Step-Audio-Tokenizer"
  
  flow:
    model_path: "./pretrained_models/stepaudio_editx/Step-Audio-EditX/CosyVoice-300M-25Hz"
    freeze_encoder: False  # 改为 False，全量微调
    freeze_vocoder: False  # 改为 False，全量微调
    n_timesteps: 10

# 优化器配置
optim:
  lr_llm: 1e-4  # 1e-4
  lr_flow: 1e-5  # 1e-5
  warmup_steps: 3000
  weight_decay: 0.01
  grad_clip: 5.0
  accum_grad: 4

# 数据配置
data:
  train_data: "./data/raw/parquet/data.list"  # parquet 文件列表
  cv_data: "./data/raw/parquet/data.list"
  sample_rate: 16000
  token_mel_ratio: 2  # token 和 mel 的比例 (CosyVoice 使用 2)
  
  # 数据过滤参数
  filter:
    max_length: 40960    # 最大音频长度（样本点）
    min_length: 100      # 最小音频长度
    token_max_length: 200
    token_min_length: 1
  
  # DataLoader 参数
  num_workers: 2
  prefetch_factor: 100
  pin_memory: True
  
  # Pipeline 参数
  shuffle_size: 1000
  sort_size: 500
  max_frames_in_batch: 2000  # 动态 batching
  use_spk_embedding: False   # 使用 utt_embedding (False) 或 spk_embedding (True)

# 保存配置
save:
  ckpt_dir: "./ckpt/finetune"
  save_best: True
  save_interval: 5

# 损失权重
loss:
  llm_weight: 0.4
  flow_weight: 0.6

# 阶段训练配置
stage:
  stage1_epochs: 25  # LLM 单独训练
  stage2_epochs: 25  # Flow 单独训练
  stage3_epochs: 5   # 联合训练
  joint_lr_scale: 0.1
